# 영속성 컨텍스트

JPA는 RDB(관계형 데이터베이스)의 테이블과 매핑되는 객체이다.

Entity를 매핑시킴.

- Entity

Entity는 테이블과 매핑될 변수들을 들고있고, 기본생성자와 getter, setter들로 이루어져있다.

보통 Id를 PK(Primary Key)값으로 한다.

- EntityManagerFactory

엔티티를 관리하는 EntityManager를 생산하는 공장 
여러 요청이 생겨도 한개만 있다.

- Entity Manager

요청이 들어올때마다 Entity Manager가 생성된다.

Thread Safe하지 않아서, 요청이 들어올때마다 각기 다른 메니저가 생성이 됨.

각각 다른 매니저가 factory에 의해 생성이 되고, DB랑 연결이 되려면 트렌젝션이 시작해야하는데, 시작할때 커넥션을 획득해야함!

![%E1%84%8B%E1%85%A7%E1%86%BC%E1%84%89%E1%85%A9%E1%86%A8%E1%84%89%E1%85%A5%E1%86%BC%20%E1%84%8F%E1%85%A5%E1%86%AB%E1%84%90%E1%85%A6%E1%86%A8%E1%84%89%E1%85%B3%E1%84%90%E1%85%B3%207af4ed3a758c43d298601cf550ab587a/Untitled.png](%E1%84%8B%E1%85%A7%E1%86%BC%E1%84%89%E1%85%A9%E1%86%A8%E1%84%89%E1%85%A5%E1%86%BC%20%E1%84%8F%E1%85%A5%E1%86%AB%E1%84%90%E1%85%A6%E1%86%A8%E1%84%89%E1%85%B3%E1%84%90%E1%85%B3%207af4ed3a758c43d298601cf550ab587a/Untitled.png)

엔티티는 엔티티매니저에 의해 영속성컨텍스트에서 관리된다.

## 영속성 컨텍스트

JPA를 학습할때 가장 중요함!!!!

엔티티를 영구 저장하는 환경!!

**엔티티 매니저는 엔티티를 영속성 컨텍스트에 보관하고 관리한다**

## 영속성 컨텍스트의 특징

1. 영속성 컨텍스트는 식별자를 가져야한다.
    1. 엔티티를 생성할때 우리는 항상 Id를 Pk값으로 지정했었다. 그런 식별자를 가져야함
    2. 왜? key-value값으로 엔티티를 관리하기 때문!

1. 트렌젝션을 커밋 해야지 JPA는 영속성 컨텍스트에 있는 엔티티를 DB에 반영한다.
    1. JPA는 트렌잭션을 커밋하는 순간, 영속성 컨텍스트에 새로 저장된 엔티티를 DB에 반영한다.
    2. 이 과정을 FLUSH라고 하는데, 영속성 컨텍스트의 변경 내용을 DB에 동기화 하는 과정을 뜻한다.(CRUD한것들)
    
2. 영속성 컨텍스트가 엔티티를 관리함으로 얻는 이점.
    1. 1차 캐시의 역할을 함
    2. 동일성을 보장함
    3. 트랜젝션을 지원하는 쓰기 지연
    4. 변경을 감지 할 수 있다.
    5. 지연 로딩
    
    ![Untitled](%E1%84%8B%E1%85%A7%E1%86%BC%E1%84%89%E1%85%A9%E1%86%A8%E1%84%89%E1%85%A5%E1%86%BC%20%E1%84%8F%E1%85%A5%E1%86%AB%E1%84%90%E1%85%A6%E1%86%A8%E1%84%89%E1%85%B3%E1%84%90%E1%85%B3%207af4ed3a758c43d298601cf550ab587a/Untitled%201.png)
    
    비영속(new/transient) : 영속성 컨텍스트와 전혀 관계가 없는 상태
    
    영속(managed): 영속성 컨텍스트에 저장된 상태
    
    준영속(detached): 영속성 컨텍스트에 저장되었다가 분리된 상태
    
    삭제(removed):삭제된 상태